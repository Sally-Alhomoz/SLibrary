@* @rendermode InteractiveServer *@

@page "/bookslist"
@* @using Blazored.Modal
@using Blazored.Modal.Services *@
@using Shared
@using Blazor2.Services
@inject IBookService bookService
@inject NavigationManager NavManager


<PageTitle>Books List</PageTitle>

<h3>Books List</h3>

<div class="mb-3 d-flex justify-content-end">
    <a href="/addbook" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add New Book
    </a>
</div>


@if (books == null)
{
    <p>Loading...</p>
}
else
{
    <div>
        <table class="table table-striped table-hover text-center">
            <thead class="table-light border-bottom border-3">
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Available</th>
                    <th>Reserved </th>
                    <th></th>
                </tr>
            </thead>
            <tbody class="text-center">
                @foreach (var book in books)
                {
                    <tr>
                        <td>@book.Title</td>
                        <td>@book.Author</td>
                        <td>@book.Available</td>
                        <td>@book.Reserved</td>
                        <td class="d-flex justify-content-center gap-2">
                            <button class="btn btn-link text-danger p-0" title="Delete Book"
                                    @onclick="() => DeleteBook(book)">
                                <i class="bi bi-trash"></i>
                            </button>

                            @if (book.Available > 0)
                            {
                                <button class="btn btn-link text-success p-0" title="Reserve Book"
                                        @onclick="() => ReserveBook(book)">
                                    <i class="bi bi-bookmark-plus-fill"></i>
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private List<Bookdto> books;
    private string message = "";
    private string messageClass = "";

    // [Inject]
    // private IModalService Modal { get; set; } = default;

    protected override async Task OnInitializedAsync()
    {
        books = await bookService.Read();
    }

    async Task DeleteBook(Bookdto book)
    {
        await bookService.Delete(book.ID);
        books = await bookService.Read();

        // message = $"Successfully deleted book: {book.Title}";
        // messageClass = "alert alert-success";

        StateHasChanged();
    }

    //async Task ReserveBook(Bookdto book)
    //{
    // message = "";


    // var parameters = new ModalParameters()
    //     .Add(nameof(ReserveModal.BookTitle), book.Title);

    // var modalReference = Modal.Show<ReserveModal>($"Reserve: {book.Title}", parameters);
    // var modalResult = await modalReference.Result;

    // if (!modalResult.Cancelled)
    // {
    //     books = await bookService.Read();

    //     message = $"Successfully reserved book: {book.Title}.";
    //     messageClass = "alert alert-success";
    // }
    // else
    // {
    //     message = $"Reservation for {book.Title} was cancelled.";
    //     messageClass = "alert alert-info";
    // }
    // StateHasChanged();
    // }

    // [Inject] IDialogService DialogService { get; set; }

    // void ShowTest()
    // {
    //     var options = new DialogOptions
    //     {
    //         CloseButton = true,
    //         MaxWidth = MaxWidth.Small,
    //         FullWidth = true
    //     };

    //     DialogService.Show<TestModal>("Test Modal", options);
    // }

    async Task ReserveBook(Bookdto book)
    {

        string title = Uri.EscapeDataString(book.Title);

        NavManager.NavigateTo($"/reservebook?title={title}");
    }
}



