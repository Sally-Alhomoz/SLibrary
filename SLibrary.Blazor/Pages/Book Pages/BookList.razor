@page "/booklist"

@using SLibrary.Blazor.Components.Modals
@using Shared
@using SLibrary.Blazor.Services.Book_Services
@using SLibrary.Blazor.Services.Authentication_Services
@inject IBookService BookService
@inject NavigationManager Nav
@inject CustomAuthStateProvider AuthProvider


<PageTitle>Books List</PageTitle>

<h2 class="text-lg-center">Books List</h2>
<br />

<div class="mb-3 d-flex justify-content-between align-items-center">
    <div>
        <input type="text" class="form-control" style="width:300px;display:inline-block"
               @bind="searchTerm" @bind:event="oninput" @onkeyup="OnSearchKeyUp"
               placeholder="Search..." />
    </div>

    @if(role == "Admin" || role == "Auditor")
    {
        <button class="btn btn-primary" @onclick="OpenAddBookModal">
            <i class="bi bi-plus-circle"></i> Add New Book
        </button>
    }

</div>
<br />

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger">
        @errorMessage
        <button class="btn btn-link p-0 ms-2" @onclick="RedirectToLogin">Login again</button>
    </div>
}
else if (!books.Any())
{
    <p class="text-center text-muted mt-5">No books found.</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-light text-center">
                <tr>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Available</th>
                    <th>Reserved</th>
                    <th></th>
                </tr>
            </thead>
            <tbody class="text-center">
                @foreach (var book in books)
                {
                    <tr>
                        <td>@book.Title</td>
                        <td>@book.Author</td>
                        <td>@book.Available</td>
                        <td>@book.Reserved</td>
                        <td class="text-center">

                            @if (role == "Admin" || role == "Auditor")
                            {
                                <button class="btn btn-sm btn-link text-danger p-0"
                                        title="Delete Book"
                                        @onclick="() => OpenDeleteModal(book)">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            }

                            @if (book.Available > 0)
                            {
                                <button class="btn btn-sm btn-link text-success p-0"
                                        title="Reserve Book"
                                        @onclick="() => OpenReserveModal(book)">
                                    <i class="bi bi-bookmark-fill"></i>
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => LoadPage(currentPage - 1)">Previous</button>
            </li>

            @for (int i = 1; i <= totalPages; i++)
            {
                var pageNum = i;
                <li class="page-item @(i == currentPage ? "active" : "")">
                    <button class="page-link" @onclick="() => LoadPage(pageNum)">@i</button>
                </li>
            }

            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <button class="page-link" @onclick="() => LoadPage(currentPage + 1)">Next</button>
            </li>
        </ul>
        <div class="text-center text-muted small">
            Showing @((currentPage - 1) * pageSize + 1)–@Math.Min(currentPage * pageSize, totalCount) of @totalCount books
        </div>
    </nav>
}
<!-- Delete Modal -->
<Modal @bind-IsVisible="showDeleteModal"
       Title="Delete Book"
       Icon="bi-trash text-danger"
       ConfirmText="Delete"
       ConfirmButtonClass="btn-danger"
       ShowCancelButton="true"
       OnConfirm="() => DeleteConfirmed()">
    <p>Are you sure you want to delete <strong>@selectedBook?.Title</strong>  book?</p>
</Modal>

<!-- Error Modal -->
<Modal @bind-IsVisible="showErrorModal"
       Title="@errorModalTitle"
       Icon="bi-exclamation-triangle text-danger"
       ConfirmText="Close"
       ConfirmButtonClass="btn-danger"
       ShowFooter="false"
       CloseOnBackdropClick="false"
       OnConfirm="() => showErrorModal = false">
    <div class="text-center py-4">
        <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545;"></i>
        <p class="lead mt-3">@((MarkupString)errorModalMessage)</p>
    </div>
</Modal>

<!-- Success Modal -->
<Modal @bind-IsVisible="showSuccessModal"
       Title="@successModalTitle"
       Icon="bi-check2-circle text-success"
       ConfirmText="Great!"
       ConfirmButtonClass="btn-success"
       ShowFooter="false"
       CloseOnBackdropClick="true"
       OnConfirm="() => showSuccessModal = false">
    <div class="text-center py-4">
        <i class="bi bi-check2-circle" style="font-size: 4rem; color: #28a745;"></i>
        <p class="lead mt-3">@((MarkupString)successModalMessage)</p>
    </div>
</Modal>

<!--Input Modals-->
<InputModal @bind-IsVisible="showReserveModal"
            Title="Reserve Book"
            Icon="bi-bookmark-fill text-success"
            ConfirmText="Reserve"
            ConfirmButtonClass="btn-success"
            FormFields="reserveFields"
            OnConfirm="ConfirmReserve" />

<InputModal @bind-IsVisible="showAddbookModal"
            Title="Add New Book"
            Icon="bi-plus-circle text-primary"
            ConfirmText="Add Book"
            ConfirmButtonClass="btn-primary"
            FormFields="addBookFields"
            OnConfirm="ConfirmAddBook" />

@code {
    private List<Bookdto> books = new();
    private string role = "";
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling(totalCount / (double)pageSize);
    private int currentPage = 1;
    private const int pageSize = 10;
    private string searchTerm = "";
    private bool isLoading = true;
    private string? errorMessage;

    private bool showDeleteModal = false;
    private Bookdto? selectedBook;

    private bool showErrorModal = false;
    private string errorModalTitle = "Error";
    private string errorModalMessage = "";

    private bool showSuccessModal = false;
    private string successModalTitle = "Success";
    private string successModalMessage = "";

    //Reserve Modal
    private bool showReserveModal = false;
    private List<InputModal.FormField> reserveFields = new();

    //Add Book Modal
    private bool showAddbookModal = false;
    private List<InputModal.FormField> addBookFields = new();

    private void OpenDeleteModal(Bookdto book)
    {
        selectedBook = book;
        showDeleteModal = true;
    }

    private async Task DeleteConfirmed()
    {
        if (selectedBook == null) return;

        try
        {
            await BookService.Delete(selectedBook.ID);
            await LoadPage(currentPage);

            showDeleteModal = false;

            successModalTitle = "Deleted!";
            successModalMessage = $"Book <strong>{selectedBook.Title}</strong> deleted successfully";
            showSuccessModal = true;
            StateHasChanged();

            await Task.Delay(1500);

            showSuccessModal = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorModalTitle = "Delete Failed";
            errorModalMessage = $"Book could not be deleted.<br><br><small>{ex.Message}</small>";
            showErrorModal = true;
        }

        selectedBook = null;
    }



    protected override async Task OnInitializedAsync()
    {
        role = await AuthProvider.GetUserRoleAsync();
        await LoadPage(1);
    }

    private async Task LoadPage(int page)
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var (items, count) = await BookService.Read(
                page: page,
                pageSize: pageSize,
                search: searchTerm.Trim(),
                sortBy: "title",
                sortDirection: "asc");

            books = items;
            totalCount = count;
            currentPage = page;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            errorMessage = "Session expired. Redirecting to login...";
            RedirectToLogin();
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load books: " + ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OpenReserveModal(Bookdto book)
    {
        selectedBook = book;

        reserveFields = new()
    {
        new InputModal.FormField
        {
            Label = "Book Title",
            Value = book.Title,
            Disabled = true,
            FullWidth = true
        },
        new InputModal.FormField
        {
            Label = "Client Name",
            Placeholder = "Enter client name",
            FullWidth = true,
            Required = true
        },
        new InputModal.FormField
        {
            Label = "Phone Number",
            Type = "tel",
            Placeholder = "Enter phone number",
            FullWidth = true,
            Required = true
        },
        new InputModal.FormField
        {
            Label = "Address",
            Type = "textarea",
            Placeholder = "Enter address",
            Required = true,
            FullWidth = true
        }
    };

        showReserveModal = true;
    }

    private async Task ConfirmReserve()
    {

        try
        {
            var success = await BookService.Reserve(
                title: selectedBook!.Title,
                clientname: reserveFields[1].Value.Trim(),
                phoneNo: reserveFields[2].Value.Trim(),
                address: reserveFields[3].Value.Trim()
            );

            if (success)
            {
                showReserveModal = false;

                successModalTitle = "Reserved!";
                successModalMessage = $"<strong>{selectedBook.Title}</strong> has been reserved successfully!";
                await LoadPage(currentPage);
                showSuccessModal = true;
                StateHasChanged();

                await Task.Delay(1500);

                showSuccessModal = false;
                StateHasChanged();
                
            }
            else
            {
                throw new Exception("Reservation failed. Book may no longer be available.");
            }
        }
        catch (Exception ex)
        {
            errorModalTitle = "Reservation Failed";
            errorModalMessage = ex.Message.Contains("Deleted")
                ? "This book has been removed and cannot be reserved."
                : ex.Message;
            showErrorModal = true;
        }

        selectedBook = null;
    }

    private void OpenAddBookModal()
    {
        addBookFields = new()
        {
            new() { Label = "Book Title", Placeholder = "Enter book title", Required = true, FullWidth = true },
            new() { Label = "Author Name", Placeholder = "Enter author name", Required = true, FullWidth = true }
        };
        showAddbookModal = true;
    }

    private async Task ConfirmAddBook()
    {
        try
        {
            var newBook = new Bookdto
            {
                Title = addBookFields[0].Value.Trim(),
                Author = addBookFields[1].Value.Trim()
            };

            await BookService.Create(newBook);

            showAddbookModal = false;

            successModalTitle = "Book Added!";
            successModalMessage = $"<strong>{newBook.Title}</strong> has been added successfully!";
            showSuccessModal = true;
            StateHasChanged();

            await Task.Delay(1500);

            await LoadPage(currentPage);
            showSuccessModal = false;
            StateHasChanged();
            showAddbookModal = false;
        }
        catch (Exception ex)
        {
            errorModalTitle = "Add Book Failed";
            errorModalMessage = $"Book could not be added.<br><br><small>{ex.Message}</small>";
            showErrorModal = true;
        }

    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await LoadPage(1);
    }

    private async Task DeleteBook(Bookdto book)
    {
        await BookService.Delete(book.ID);
        await LoadPage(currentPage);
    }


    private void RedirectToLogin()
    {
        Nav.NavigateTo("/login", forceLoad: true);
    }

}