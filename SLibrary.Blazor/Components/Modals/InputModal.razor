<Modal @bind-IsVisible="IsVisible"
       Title="@Title"
       Icon="@Icon"
       ConfirmText="@ConfirmText"
       ConfirmButtonClass="@ConfirmButtonClass"
       OnConfirm="HandleConfirm"
       IsBusy="IsBusy">


    @if (FormFields.Any())
    {
        <div class="row g-3">
            @foreach (var field in FormFields)
            {
                <div class="@(field.FullWidth ? "col-12" : "col-md-6")">
                    <label class="form-label">
                        @field.Label
                        @if (field.Required)
                        {
                            <span class="text-danger">*</span>
                        }
                    </label>

                    @if (field.Type == "textarea")
                    {
                        <textarea class="form-control @(field.HasError ? "is-invalid" : "")"
                                  rows="@field.Rows"
                                  @bind="field.Value"
                                  placeholder="@field.Placeholder"
                                  disabled="@field.Disabled"></textarea>
                    }
                    else
                    {
                        <input type="@(field.Type ?? "text")"
                               class="form-control @(field.HasError ? "is-invalid" : "")"
                               @bind="field.Value"
                               placeholder="@field.Placeholder"
                               disabled="@field.Disabled" />
                    }

                    @if (field.HasError && !string.IsNullOrEmpty(field.ErrorMessage))
                    {
                        <div class="invalid-feedback">@field.ErrorMessage</div>
                    }
                </div>
            }
        </div>
    }
    else
    {
        @ChildContent
    }
</Modal>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    [Parameter] public bool IsBusy { get; set; } = false;
    [Parameter] public string Title { get; set; } = "Action";
    [Parameter] public string? Icon { get; set; }
    [Parameter] public string ConfirmText { get; set; } = "Confirm";
    [Parameter] public string ConfirmButtonClass { get; set; } = "btn-primary";
    [Parameter] public RenderFragment? ChildContent { get; set; }

    [Parameter] public List<FormField> FormFields { get; set; } = new();
    [Parameter] public EventCallback OnConfirm { get; set; }

    private async Task HandleConfirm()
    {
        bool hasError = false;
        foreach (var f in FormFields.Where(f => f.Required))
        {
            f.HasError = string.IsNullOrWhiteSpace(f.Value);
            if (f.HasError) hasError = true;
        }

        if (hasError)
        {
            StateHasChanged();
            return;
        }

        if (OnConfirm.HasDelegate)
            await OnConfirm.InvokeAsync();
    }

    public class FormField
    {
        public string Label { get; set; } = "";
        public string? Type { get; set; } = "text";
        public string Value { get; set; } = "";
        public string Placeholder { get; set; } = "";
        public bool Required { get; set; } = false;
        public bool Disabled { get; set; } = false;
        public bool FullWidth { get; set; } = false;
        public int Rows { get; set; } = 3;
        public bool HasError { get; set; } = false;
        public string ErrorMessage { get; set; } = "This field is required";
    }
}