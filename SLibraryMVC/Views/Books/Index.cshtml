@{
    ViewData["Title"] = "Books List";
}
@model IEnumerable<Shared.Bookdto>

<div class="text-dark">
    <h1 class="display-4">Books List</h1>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
    }

    @if (User.IsInRole("Admin") || User.IsInRole("Auditor"))
    {
        <p>
            <a asp-action="Create" class="btn btn-primary">Add New Book</a>
        </p>
    }


    <br />


    <table class="table" id="BooksTable">
        <thead class="text-center">
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Reserved </th>
                <th>Available</th>
                <th></th>
            </tr>
        </thead>
        <tbody class="text-center">
            @if (Model != null && Model.Any())
            {
                foreach (var book in Model)
                {
                    <tr>
                        <td>@book.Title</td>
                        <td>@book.Author</td>
                        <td>@book.Reserved</td>
                        <td>@book.Available</td>
                        <td class="d-flex justify-content-center gap-2">
                            @if (User.IsInRole("Admin") || User.IsInRole("Auditor"))
                            {
                                <form asp-controller="Books" asp-action="Delete" asp-route-id="@book.ID" method="post">
                                    <button type="button" class="btn btn-link text-danger p-0 action-button" title="Delete"
                                            data-action-type="Delete"
                                            data-book-title="@book.Title">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            }
                            @if (book.Available > 0)
                            {
                                <form asp-action="Reserve" asp-route-title="@book.Title" method="post">
                                    <button type="button" class="btn btn-link text-success p-0 action-button" title="Reserve Book"
                                            data-action-type="Reserve"
                                            data-book-title="@book.Title">
                                        <i class="bi bi-bookmark-plus-fill"></i>
                                    </button>
                                </form>
                            }
                            @if (!User.IsInRole("Admin") && !User.IsInRole("Auditor") && book.Available == 0)
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>

                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="5" class="text-center text-muted">No books found</td>
                </tr>
            }
        </tbody>
    </table>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modalMessage"></p>
                </div>

                <div class="mb-3" id="PhoneNo" style="display:none">
                    <label for="PhoneNoInput" class="form-label">Phone Number:</label>
                    <input type="text" class="form-control" id="PhoneNoInput" required>
                </div>

                <div class="mb-3" id="clientName" style="display:none">
                    <label for="clientNameInput" class="form-label">Client Name:</label>
                    <input type="text" class="form-control" id="clientNameInput" required>
                </div>


                <div class="mb-3" id="Address" style="display:none">
                    <label for="AddressInput" class="form-label">Address:</label>
                    <input type="text" class="form-control" id="AddressInput" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">


    <script>
        $(document).ready(function () {
            $('#BooksTable').DataTable({
                "columnDefs": [
                    { "orderable": false, "targets": 4 }
                ]
            });
        });


        var formToSubmit = null;

        $('.action-button').on('click', function () {

            $('#confirmActionButton').off('click');

            formToSubmit = $(this).closest('form');

            var actionType = $(this).data('action-type');
            var bookTitle = $(this).data('book-title');
            var msg = "";

            $('#PhoneNo, #clientName, #Address').hide();
            $('#PhoneNoInput, #clientNameInput, #AddressInput').prop('required', false).val('');

            if (actionType == 'Delete') {
                msg = `Are you sure you want to delete the book: <strong>${bookTitle}</strong>?`;
                $('#confirmationModal .modal-header').removeClass('bg-success').addClass('bg-danger');
                $('#confirmActionButton').removeClass('btn-success').addClass('btn-danger').text('Delete');

            } else if (actionType == 'Reserve') {
                msg = `Please enter the client's information to reserve book: <strong>${bookTitle}</strong>.`;
                $('#PhoneNo, #clientName, #Address').show();
                $('#PhoneNoInput, #clientNameInput, #AddressInput').prop('required', true);
                $('#confirmationModal .modal-header').removeClass('bg-danger').addClass('bg-success');
                $('#confirmActionButton').removeClass('btn-danger').addClass('btn-success').text('Reserve');
            }

            $('#modalMessage').html(msg);

            var myModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            myModal.show();

            $('#confirmActionButton').on('click', function () {

                if (actionType == 'Reserve') {
                    var phoneNo = $('#PhoneNoInput').val().trim();
                    var name = $('#clientNameInput').val().trim();
                    var address = $('#AddressInput').val().trim();

                    if (!phoneNo || !name || !address) {
                        alert('All client fields (Phone, Name, Address) are required.');
                        return;
                    }

                    formToSubmit.find('input[name="phoneNo"], input[name="clientname"], input[name="address"]').remove();

                    $('<input>').attr({ type: 'hidden', name: 'phoneNo', value: phoneNo }).appendTo(formToSubmit);
                    $('<input>').attr({ type: 'hidden', name: 'clientname', value: name }).appendTo(formToSubmit);
                    $('<input>').attr({ type: 'hidden', name: 'address', value: address }).appendTo(formToSubmit);
                }

                if (formToSubmit) {
                    formToSubmit.submit();
                }
            });

        });
    </script>
}