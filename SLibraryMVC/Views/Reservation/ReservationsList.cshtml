@{
    ViewData["Title"] = "Reservations List";
}

@model List<Shared.Reservationdto>

<div class="text">
    <h1 class="display-4">Reservations</h1>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
    }


    <br/>


    <table id="ReservationsTable" class="table">
        <thead class="text-center">
            <tr>
                <th>Reserved By</th>
                <th>Client Name</th>
                <th>Book Title</th>
                <th>Reserve Date</th>
                <th>Release Date</th>
                <th>Reservation Period</th>
            </tr>
        </thead>
        <tbody class="text-center">
            @foreach(var r in Model)
            {
                <tr>
                    <td>@r.ReservedBy</td>
                    <td>
                        <div class="d-flex justify-content-center gap-2 align-items-center">

                            <span>@r.ClientName</span>
                            <a asp-controller="Reservation" asp-action="ClientInfo"
                               asp-route-clientname="@r.ClientName"
                               class="btn btn-link text-info p-0"
                               title="View Client Details">
                                <i class="bi bi-eye-fill"></i>
                            </a>

                        </div>
                    </td>
                    <td>@r.BookTitle</td>
                    <td>@r.ReservedDate</td>
                    <td>
                        @if(r.ReleaseDate.HasValue)
                        {
                            @r.ReleaseDate
                        }
                        else
                        {
                           <form asp-controller="Reservation" asp-action="Release" method="post">

                                @Html.AntiForgeryToken()

                                <input type="hidden" name="clientname" value="@r.ClientName" />
                               <input type="hidden" name="title" value="@r.BookTitle" />

                                <button type="button" class="btn btn-link text-danger p-0 action-button" title="Release Book"
                                        data-action-type="Release"
                                        data-book-title="@r.BookTitle">
                                    <i class="fas fa-arrow-alt-circle-up"></i> Release
                               </button>
                           </form>
                        }

                    </td>
                    <td>
                        @if (r.ReleaseDate.HasValue)
                        {
                            string days = @r.ReservationPeriod.Days > 0 ? $"{@r.ReservationPeriod.Days} dy" : "";
                            string hours = @r.ReservationPeriod.Hours > 0 ? $"{@r.ReservationPeriod.Hours} hr" : "";
                            string minutes = @r.ReservationPeriod.Minutes > 0 ? $"{@r.ReservationPeriod.Minutes} min" : "";

                            string Period = string.Join(", ", new[] { days, hours, minutes }.Where(s => !string.IsNullOrEmpty(s)));

                            if (string.IsNullOrEmpty(Period))
                            {
                                Period = $"{@r.ReservationPeriod.Seconds} sec";
                            }
                            <span class="text-dark">@Period</span>
                        }
                        else
                        {
                            <span class="badge bg-success">Ongoing</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="modal fade" id="confirmation" tabindex="-1" aria-labelledby="confirmationLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmationLabel">Confirmation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="modalMessage"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmActionButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
@*     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> *@

    <script>
        $(document).ready(function ()
        {
            $('#ReservationsTable').DataTable({
                "columnDefs": [
                    { "orderable": false, "targets": 3 } 
                ]
            });
        });

        var formToSubmit;

        $('#confirmActionButton').on('click', function () {
            if (formToSubmit) {
                formToSubmit.submit();
            }
        });

        $('.action-button').on('click', function () {
            formToSubmit = $(this).closest('form');

            var actionType = $(this).data('action-type');
            var bookTitle = $(this).data('book-title');
            var msg = `Are you sure you want to release the book:  <strong>${bookTitle}</strong>?`;

            $('#modalMessage').html(msg);


            var myModal = new bootstrap.Modal(document.getElementById('confirmation'));
            myModal.show();
        });
    </script>
}